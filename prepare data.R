# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# CODE AUTHOR:    Jakob Manthey

# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 0) ESSENTIALS
# ______________________________________________________________________________________________________________________

# clean workspace
rm(list=ls())

# input path
inpath <- paste0("C:/Data.work/PRAGMA/Daten/data_clean_1/")

# output path
outpath <- paste0("data/output/")

# load libraries
library( data.table )
library( ggplot2 )
library( ggthemes )
library( tidyr )
library( stringr )

# themes and options
theme_set( theme_gdocs() )
options(scipen = 999)


# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 1) LOAD DATA
# ______________________________________________________________________________________________________________________

# 1.1) DATA SET 1 - use problems
# ----------------------------------------------

filename <- "input/Zi_data_all and with rates_230714.csv"
input1 <- data.table(read.csv(filename))[,.(state,year,sex,age,f12,gkv_pop = gkv.pop)]
nrow(input1) # 4641

# F12 = number of persons with F12 diagnosis in that strata (state-year-sex-age)
# gkv.pop = number of insured persons


# 1.2) DATA SET 2 - use prevalence - all with rates
# ----------------------------------------------

filename <- "input/USE_complete and age-stand_230717.csv"
input2 <- data.table(read.csv(filename))[,.(state,year,sex,age,use_prev = est)]
nrow(input2) # 3315

# use_prev/est = use prevalence in that strata (state-year-sex-age)

# 1.3) DATA SET 3 - THC data states
# ----------------------------------------------

filename <- "input/THC_data_230428.csv"
input3 <- data.table(read.csv(filename))[,.(state = Bundesland,year,type,thc = THC)]
nrow(input3) # 3315

# type = harz (hashish/resin) or Blüten (flower)

# 1.4) DATA SET 4 - THC national
# ----------------------------------------------

filename <- "input/THC Bundesweit.xlsx"
input4 <- data.table(openxlsx::read.xlsx(filename))[,.(year,type,thc)]
nrow(input4) # 39



# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 2) PREPARE DATA
# ______________________________________________________________________________________________________________________

# 2.1) Combine data
# ----------------------------------------------

data <- copy(input1[age == "15-64",.(state,year,sex,f12,gkv_pop)])
data <- merge(data,
              input2[age == "12-59",.(state,year,sex,use_prev)], 
              by = c("state","year","sex"))

# get "Diagnoseanteil" (diagnostic proportion) in 0 to 100 (rather than 0 to 1)
data[, diag_prop := f12/(gkv_pop*use_prev)*100]


# add THC deviation from 12%
thc <- rbind(input3[type == "Blüten" & year >= 2009,.(state,year,thc_dev = thc - 12)],
             input4[type == "flower" & year >= 2009,.(state = "Bund",year,thc_dev = thc - 12)])

thc[, table(state)]

data <- merge(data, thc, by = c("state","year"))
data[!complete.cases(data)] # none

# remove unnecessary variables
data <- data[,.(state,sex,year,diag_prop,thc_dev)]


# 2.2) THC deviation and lags
# ----------------------------------------------

lag_dat <- copy(data[order(state,sex,year),.(state,sex,year,thc_dev)])

for (lag in 0:10) {

  # Create lagged variable
  lagged_variable <- paste("thc_dev_lag", lag, sep = "_")
  
  lag_dat[, lagged_variable := shift(thc_dev, lag), by = .(state,sex)]
  lag_dat[[lagged_variable]] <- lag_dat$lagged_variable
  lag_dat$lagged_variable <- NULL
  
  }

# add lags to data
data <- merge(data,
              lag_dat,
              by = c("state","sex","year","thc_dev"), all.x = T)

data <- data[,.SD, by = .(state,sex,year,diag_prop,thc_dev)]

# 2.3) Variable definitions
# ----------------------------------------------

# 



# ==================================================================================================================================================================
# ==================================================================================================================================================================
# ==================================================================================================================================================================

# 3) SAVE DATA
# ______________________________________________________________________________________________________________________

write.csv(data, "data/data.csv", row.names = F)